#!/usr/bin/env node

const fs = require('fs');
const childProcessExec = require('child_process').exec;
const util = require('util');
// åˆ†æ”¯åç§°
const BRANCH_CONTRACT = /^(feature|hotfix|chore|docs|refactor)-\w+/;
// COMMIT MESSAGE é•¿åº¦é™åˆ¶
const COMMIT_MESSAGE_LIMIT_LENGTH = 20;
// COMMIT MESSAGE æ£€æŸ¥
const CODE_CONTRACT = /^(feat|fix|docs|chore|refactor)\(\w+\)?:\s(\S|\w)+/;

const TIMEOUT_THRESHOLD = 3000;


const COLORS = {
  Reset: '\x1b[0m',
  Bright: '\x1b[1m',
  Dim: '\x1b[2m',
  Underscore: '\x1b[4m',
  Blink: '\x1b[5m',
  Reverse: '\x1b[7m',
  Hidden: '\x1b[8m',
  FgBlack: '\x1b[30m',
  FgRed: '\x1b[31m',
  FgGreen: '\x1b[32m',
  FgYellow: '\x1b[33m',
  FgBlue: '\x1b[34m',
  FgMagenta: '\x1b[35m',
  FgCyan: '\x1b[36m',
  FgWhite: '\x1b[37m',
  BgBlack: '\x1b[40m',
  BgRed: '\x1b[41m',
  BgGreen: '\x1b[42m',
  BgYellow: '\x1b[43m',
  BgBlue: '\x1b[44m',
  BgMagenta: '\x1b[45m',
  BgCyan: '\x1b[46m',
  BgWhite: '\x1b[47m',
};

const ERROR_MESSAGE = {
  BRANCH_NAME_ERROR: "âŒ  ERROR: ä½ çš„åˆ†æ”¯åæ²¡æœ‰æŒ‰ç…§è§„èŒƒï¼Œæˆ‘æœ‰ç‚¹å¿å—ä¸äº†ã€‚",
  BRANCH_NAME_ERROR_TIP: `â¤ï¸  INFO: è¯·æŒ‰ç…§è§„èŒƒåˆ‡æ¢åˆ†æ”¯ ${BRANCH_CONTRACT}`,
  COMMIT_MESSAGE_TOO_SHORT:
    'âŒ  ERROR: ä½ çš„ commit message ç®€ç›´å¤ªçŸ­äº†ï¼Œæˆ‘æœ‰ç‚¹å¿å—ä¸äº†ã€‚è¯·å°½å¯èƒ½è¯¦å°½åœ°æè¿°ä½ è§£å†³çš„é—®é¢˜ã€‚',
  COMMIT_MESSAGE_STANDARD_TIP: 'åŒ…å«ï¼šåŠŸèƒ½å®ç°ï¼ŒæŠ€æœ¯éš¾ç‚¹ï¼Œç®€æ˜ä¸šåŠ¡é€»è¾‘ç­‰...',
  COMMIT_MESSAGE_INVALID: 'âŒ  ERROR: ä¸åˆæ³•çš„ commit message, è¯·éµå®ˆ commit message æäº¤è§„èŒƒã€‚',
  COMMIT_MESSAGE_LINK: 'è¯·ä»”ç»†é˜…è¯»è§„èŒƒï¼šhttps://www.conventionalcommits.org/en/v1.0.0-beta.3/',
  COMMIT_CHECK_SUCCESS: 'ğŸ˜  SUCCESS: å¤ªèµäº†ï¼Œcommit message é€šè¿‡äº†æ£€æŸ¥',
};

const exec = util.promisify(childProcessExec);

checkCommitMessage();
hookCleanup();

async function checkCommitMessage() {
  const message = fs.readFileSync(process.argv[2], 'utf8').trim();
  let branchName = '';
  try {
    branchName = await getCurrentBranch();
  } catch (e) {
    handleGitBranchCommandError(e);
  }

  if (!BRANCH_CONTRACT.test(branchName)) {
    handleBadBranchName();
  }

  if (message.length < COMMIT_MESSAGE_LIMIT_LENGTH) {
    showCommitMessage(message);
    console.log(
      COLORS.FgRed,
      ERROR_MESSAGE.COMMIT_MESSAGE_TOO_SHORT,
      COLORS.FgGreen,
      ERROR_MESSAGE.COMMIT_MESSAGE_STANDARD_TIP
    );
    process.exit(1);
  }

  if (!CODE_CONTRACT.test(message)) {
    showCommitMessage(message);
    handleBadCommitMessage();
  }

  console.log(`\n${COLORS.FgGreen}\n`, ERROR_MESSAGE.COMMIT_CHECK_SUCCESS);
  process.exit(0);
}

function showCommitMessage(message) {
  console.log(
    COLORS.FgBlue,
    '\n ä½ çš„ commit message æ˜¯:',
    COLORS.FgYellow,
    `${message} \n`
  );
}

function handleBadCommitMessage() {
  console.log(COLORS.FgRed, ERROR_MESSAGE.COMMIT_MESSAGE_INVALID, COLORS.FgGreen, ERROR_MESSAGE.COMMIT_MESSAGE_LINK);
  process.exit(1);
}

async function getCurrentBranch() {
  const branchesOutput = await exec('git branch');
  if (branchesOutput.stderr) {
    throw new Error(stderr);
  }
  const branches = branchesOutput.stdout;
  return branches
    .split('\n')
    .find(b => b.trim().charAt(0) === '*')
    .trim()
    .substring(2);
}

function handleGitBranchCommandError(e) {
  console.log(COLORS.FgRed, ERROR_MESSAGE.BRANCH_NAME_ERROR);
  console.log(COLORS.FgBlue, ERROR_MESSAGE.BRANCH_NAME_ERROR_TIP);
  console.log(COLORS.FgRed, e.getMessage());
  process.exit(1);
}

function handleBadBranchName() {
  console.log(`\n${COLORS.FgRed}%s\n`, ERROR_MESSAGE.BRANCH_NAME_ERROR);
  console.log(`\n${COLORS.FgBlue}%s\n`, ERROR_MESSAGE.BRANCH_NAME_ERROR_TIP);
  process.exit(1);
}


function hookCleanup() {
  setTimeout(() => {
    console.log(
      'This is a timeout message from your commit-msg git hook. If you see this, something bad happened in your pre-commit hook, and it absolutely did not work as expected.'
    );
    console.log(
      ' Your commit will be rejected. Please read any previous error message related to your commit message, and/or check the commit-msg git hook script.'
    );
    console.log(
      ' You can find more info in this link: https://git-scm.com/book/uz/v2/Customizing-Git-An-Example-Git-Enforced-Policy'
    );
    process.exit(1);
  }, TIMEOUT_THRESHOLD);
}
